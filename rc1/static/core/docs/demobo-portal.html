<!DOCTYPE html>

<html>
<head>
  <title>demobo-portal.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>demobo-portal.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <p>Generated by CoffeeScript 1.6.2</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="comment">/*</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>demobo-portal.js 1.0.0</p>
<p>(c) 2013 Jiahao Li, de Mobo LLC</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>*/


/*</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p><code>window.demoboLoading</code> is a flag that keeps loading bookmarklet safe</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>*/


(function() {
  var Bobo, DemoboPortal, Dispatcher, base, breaker, cacheJS, connectScript, demoboHandlers, dev, extend, loadJS, nativeForEach, remotes, version, _,
    __indexOf = [].indexOf || function(item) { for (var i = 0, l = this.length; i &lt; l; i++) { if (i in this &amp;&amp; this[i] === item) return i; } return -1; };

  if (!window.demoboLoading) {
    /*</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>Set the flag so that another demobo script wont interrupt</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    */

    window.demoboLoading = 1;
    if (window.demoboOn) {
      /*</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>If demobo is already on, do nothing</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      */

      delete window.demoboLoading;
    } else {
      window.demoboOn = 1;
      /*</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap for-h2">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <h2>Baseline Setup</h2>

            </div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>Current version</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      */

      version = '1.0.0';
      /*</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>Set this to false if production. In local environment, the Google App Engine server serves as the http server, and Apache server(default on port 443) is the https server. In production environment, a server will serve both http and https requests.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      */

      dev = window.demoboDev;
      if (dev) {
        base = window.demoboBase + '/apps/';
        connectScript = window.demoboBase + '/core/connect.js';
      } else {
        base = '//rc1-dot-de-mobo.appspot.com/apps/';
        connectScript = '//rc1-dot-de-mobo.appspot.com/core/connect.js';
      }
      /*</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>This sets the routing of controllers for websites (currently hardcoded)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      */

      remotes = {
        'www.pandora.com': 'pandora.com-new.js',
        'douban.fm': 'douban.fm-new.js',
        'www.youtube.com': 'youtube.com-new.js',
        'www.last.fm': 'last.fm-new.js',
        '8tracks.com': '8tracks.com-new.js',
        'vimeo.com': 'vimeo.com-new.js',
        'youku.com': 'youku.com-new.js',
        'www.rdio.com': 'rdio.com-new.js',
        'grooveshark.com': 'grooveshark.com-new.js',
        'play.spotify.com': 'spotify.com-new.js',
        'www.yelp.com': 'yelp.com.js',
        'sfbay.craigslist.org': 'yelp.com.js',
        'www.yellowpages.com': 'yelp.com.js',
        'www.foodspotting.com': 'yelp.com.js',
        'www.urbanspoon.com': 'yelp.com.js'
      };
      /*</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap for-h2">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <h2>definitions of utilities </h2>

            </div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>A function that caches a script using object tag</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      */

      cacheJS = function(src) {
        var cache;

        cache = document.createElement('object');
        cache.data = src;
        cache.className = 'demoboCache';
        cache.width = 0;
        cache.height = 0;
        return document.body.appendChild(cache);
      };
      /*</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>Try to preload demobo API and other scripts as early as possible</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      */

      cacheJS('//api.demobo.com/demobo.1.7.0.min.js');
      cacheJS(connectScript);
      /*</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>A function that loads a script and executes the call back after the script is executed</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      */

      loadJS = function(src, f) {
        var script;

        script = document.createElement('script');
        script.setAttribute('type', 'text/javascript');
        script.setAttribute('src', src);
        script.className = 'demoboJS';
        document.body.appendChild(script);
        return script.onload = f;
      };
      /*</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap for-h2">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <h2>external libraries </h2>

            </div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>Constants used by underscore.js codes</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      */

      _ = {};
      nativeForEach = Array.prototype.forEach;
      breaker = {};
      /*</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>Functions defined by underscore.js</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      */

      
    _.each = function(obj, iterator, context) {
      if (obj == null) return;
      if (nativeForEach &amp;&amp; obj.forEach === nativeForEach) {
        obj.forEach(iterator, context);
      } else if (obj.length === +obj.length) {
        for (var i = 0, l = obj.length; i &lt; l; i++) {
          if (iterator.call(context, obj[i], i, obj) === breaker) return;
        }
      } else {
        for (var key in obj) {
          if (_.has(obj, key)) {
            if (iterator.call(context, obj[key], key, obj) === breaker) return;
          }
        }
      }
    };
      _.has = function(obj, key) {
        return Object.prototype.hasOwnProperty.call(obj, key);
      };
      
    _.extend = function(obj) {
      _.each(Array.prototype.slice.call(arguments, 1), function(source) {
        if (source) {
          for (var prop in source) {
            obj[prop] = source[prop];
          }
        }
      });
      return obj;
    };
      /*</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>Codes copied and adapted from backbone.js. Used for inheritance</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      */

      extend = function(protoProps, staticProps) {
        var child, parent;

        parent = this;
        if (protoProps &amp;&amp; _.has(protoProps, 'constructor')) {
          child = protoProps.constructor;
        } else {
          child = function() {
            return parent.apply(this, arguments);
          };
        }
        _.extend(child, parent, staticProps);
        function ctor() { this.constructor = child; } 
      ctor.prototype = parent.prototype; 
      child.prototype = new ctor(); 
      child.__super__ = parent.prototype;
        return child;
      };
      /*</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap for-h2">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <h2>Bobo base class</h2>

            </div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>Base class of all BOBOs. Every new bobo should extend this class and overwrite at least its <code>initialize</code> method</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      */

      Bobo = (function() {
        /*</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>Constructor of <code>Bobo</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        */
        function Bobo(portal) {
          var defaultConfig;

          this.portal = portal;
          this.boboInfos = {};
          this._events = {};
          defaultConfig = {
            'developer': 'developer@demobo.com'
          };
          this.boboInfos['config'] = defaultConfig;
          this.boboInfos['boboID'] = null;
          this.boboInfos['connectedDevices'] = {};
          this.boboInfos['inputEventHandlers'] = {};
          this.initialize();
        }

        /*</pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>Register a event handler to the Object&#39;s properties. In the handler, <code>this</code> refers to this object. Example:</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        */


        Bobo.prototype.on = function(eventName, handler) {
          this._events[eventName] = handler;
          return true;
        };

        /*</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>Trigger specific event handler</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        */


        Bobo.prototype.trigger = function(eventName) {
          var handler;

          if ((handler = this._events[eventName])) {
            handler.apply(this, [].slice.apply(arguments, [1]));
            return true;
          } else {
            return false;
          }
        };

        /*</pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p>Call the function on device. if <code>devicedID</code> is not specified, call the function on all devices connected to this bobo</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        */


        Bobo.prototype.callFunction = function(functionName, data, deviceID) {
          return this.portal.callFunction(functionName, data, deviceID, this.getInfo('boboID'));
        };

        /*</pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p>Called immediately upon this bobo&#39;s instantiation (guaranteed). A bobo that inherits the base <code>Bobo</code> class should overwrite this method</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        */


        Bobo.prototype.initialize = function() {
          this.setInfo('controller', {});
          this.setInfo('inputEventHandlers', {});
          return true;
        };

        /*</pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p>Return the value of the key</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        */


        Bobo.prototype.getInfo = function(key) {
          return this.boboInfos[key];
        };

        /*</pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <p>set the value of the key. If the old value is different from the new value, &#39;change:<code>key</code>&#39; event is triggered</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        */


        Bobo.prototype.setInfo = function(key, val) {
          var oldVal;

          oldVal = this.boboInfos[key];
          if (oldVal !== val) {
            this.boboInfos[key] = val;
            this.trigger('change:' + key, oldVal, val);
          }
          return oldVal;
        };

        /*</pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <p>set controller params. which will be passed to phone when new device is connected</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        */


        Bobo.prototype.setController = function(params) {
          return this.setInfo('controller', params);
        };

        /*</pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <p>set event listeners. which will be in turn set to demobo when the bobo is instantiated</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        */


        Bobo.prototype.setInputEventHandlers = function(inputEventHandlers) {
          var eventName, handlerName, hs, wrapper, _thisBobo;

          _thisBobo = this;
          wrapper = function(bobo, functionName) {
            return function() {
              return bobo[functionName].apply(bobo, arguments);
            };
          };
          hs = {};
          for (eventName in inputEventHandlers) {
            handlerName = inputEventHandlers[eventName];
            hs[eventName] = wrapper(_thisBobo, handlerName);
          }
          this.setInfo('inputEventHandlers', hs);
          return true;
        };

        /*</pre></div></div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <p>reservered for future use</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        */


        Bobo.prototype.run = function() {};

        /*</pre></div></div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <p>reservered for future use</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        */


        Bobo.prototype.resume = function() {};

        /*</pre></div></div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              <p>reservered for future use</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        */


        Bobo.prototype.finish = function() {};

        return Bobo;

      })();
      /*</pre></div></div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
              <p>Set up <code>Bobo</code> for global use</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      */

      Bobo.extend = extend;
      window.Bobo = Bobo;
      /*</pre></div></div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-33">&#182;</a>
              </div>
              <p>a dispatcher object for event listeners</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      */

      Dispatcher = (function() {
        /*</pre></div></div>
            
        </li>
        
        
        <li id="section-34">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-34">&#182;</a>
              </div>
              <p>Constructor of <code>Dispatcher</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        */
        function Dispatcher(eventListened, portal) {
          this.eventListened = eventListened;
          this.portal = portal;
          this.handlers = {};
        }

        /*</pre></div></div>
            
        </li>
        
        
        <li id="section-35">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-35">&#182;</a>
              </div>
              <p>add a bobo&#39;s event handler</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        */


        Dispatcher.prototype.addHandler = function(boboID, handler) {
          return this.handlers[boboID] = handler;
        };

        /*</pre></div></div>
            
        </li>
        
        
        <li id="section-36">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-36">&#182;</a>
              </div>
              <p>call corresponding handler based on <code>deviceID</code> (and its corresponding <code>boboID</code>)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        */


        Dispatcher.prototype.dispatch = function(value, data) {
          var boboID, deviceID;

          deviceID = data.deviceID;
          boboID = this.portal.getDeviceBoboID(deviceID);
          if (__indexOf.call(Object.keys(this.handlers), boboID) &gt;= 0) {
            return this.handlers[boboID](value, data);
          }
          return null;
        };

        return Dispatcher;

      })();
      /*</pre></div></div>
            
        </li>
        
        
        <li id="section-37">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-37">&#182;</a>
              </div>
              <p>Handlers used by a <code>DemoboPortal</code> object, which listen to the change of the object&#39;s properties, e.g. change of bobos, addition of new bobo, etc.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      */

      demoboHandlers = {
        handlerBobosChange: function(oldVal, newVal) {
          return console.log('bobos changed from ' + oldVal + ' to ' + newVal);
        },
        handlerCurBoboChange: function(oldVal, newVal) {
          return console.log('current bobo changed from ' + oldVal + ' to ' + newVal);
        },
        handleBoboAdd: function(boboID, boboObj) {
          return console.log('new bobo added, id: ' + boboID);
        },
        /*</pre></div></div>
            
        </li>
        
        
        <li id="section-38">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-38">&#182;</a>
              </div>
              <p>Handler that runs when a new device is connected</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        */

        connectedHandler: function(portal) {
          return function(data) {
            console.log('connected');
            console.log(portal);
            portal.setDeviceController(portal.get('curBobo'), data.deviceID);
            return portal.addDevice(data.deviceID);
          };
        },
        /*</pre></div></div>
            
        </li>
        
        
        <li id="section-39">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-39">&#182;</a>
              </div>
              <p>Handler that runs when a new device is disconnected</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        */

        disconnectedHandler: function(portal) {
          return function(data) {
            console.log('disconnected');
            console.log(portal);
            return portal.removeDevice(data.deviceID);
          };
        }
      };
      /*</pre></div></div>
            
        </li>
        
        
        <li id="section-40">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-40">&#182;</a>
              </div>
              <p>Class definition of DemoboPortal</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      */

      DemoboPortal = (function() {
        /*</pre></div></div>
            
        </li>
        
        
        <li id="section-41">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-41">&#182;</a>
              </div>
              <p>constructor of <code>DemoboPortal</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        */
        function DemoboPortal() {
          this.attributes = {};
          this.DEMOBO = window.DEMOBO;
          this.demobo = window.demobo;
          this.DEMOBO_DEBUG = window.DEMOBO_DEBUG;
          this._events = {};
          this.initialize();
        }

        /*</pre></div></div>
            
        </li>
        
        
        <li id="section-42">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-42">&#182;</a>
              </div>
              <p>Get current website&#39;s remote control url</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        */


        DemoboPortal.prototype.getRemote = function() {
          var domain, key, val;

          domain = document.domain;
          for (key in remotes) {
            val = remotes[key];
            if (key === domain) {
              return val;
            }
          }
          return null;
        };

        /*</pre></div></div>
            
        </li>
        
        
        <li id="section-43">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-43">&#182;</a>
              </div>
              <p>Return an object that contains all available bobos for the current website.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        */


        DemoboPortal.prototype.getBoboRoutes = function() {
          var remote, toReturn;

          toReturn = {};
          remote = this.getRemote();
          if (remote) {
            toReturn['remote'] = base + remote;
          }
          return toReturn;
        };

        /*</pre></div></div>
            
        </li>
        
        
        <li id="section-44">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-44">&#182;</a>
              </div>
              <p>Called immediately upon the object&#39;s instantiation (guaranteed)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        */


        DemoboPortal.prototype.initialize = function() {
          var boboRoutes, name, route;

          boboRoutes = this.getBoboRoutes();
          this.set('version', version);
          this.set('bobos', {});
          this.set('eventHandlers', {});
          this.set('deviceBoboMap', {});
          this.set('boboDeviceMap', {});
          this.set('curBobo', null);
          this.set('boboRoutes', boboRoutes);
          this.demobo.addEventListener('connected', demoboHandlers.connectedHandler(this));
          /* handlers when a device is connected
          */

          this.demobo.addEventListener('disconnected', demoboHandlers.disconnectedHandler(this));
          /* handlers when a device is disconnected
          */

          this.on('change:bobos', demoboHandlers.handlerBobosChange);
          this.on('change:curBobo', demoboHandlers.handlerCurBoboChange);
          this.on('add:bobos', demoboHandlers.handleBoboAdd);
          window.DEMOBO.init = function() {};
          window.demobo.start();
          for (name in boboRoutes) {
            route = boboRoutes[name];
            loadJS(route);
          }
          return true;
        };

        /*</pre></div></div>
            
        </li>
        
        
        <li id="section-45">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-45">&#182;</a>
              </div>
              <p>Add a connected device and map it to the current bobo</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        */


        DemoboPortal.prototype.addExistentDevice = function(data) {
          var deviceID;

          deviceID = data.deviceID;
          this.setDeviceController(this.get('curBobo'), deviceID);
          return this.addDevice(deviceID);
        };

        /*</pre></div></div>
            
        </li>
        
        
        <li id="section-46">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-46">&#182;</a>
              </div>
              <p>Make an rpc on the device. if <code>deviceID</code> is not specified, make the rpc on all devices connected to the specified bobo</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        */


        DemoboPortal.prototype.callFunction = function(functionName, data, deviceID, boboID) {
          var dID, deviceIDs, _i, _len;

          if (deviceID) {
            return this.demobo.callFunction(functionName, data, deviceID);
          } else {
            deviceIDs = this.get('boboDeviceMap')[boboID];
            for (_i = 0, _len = deviceIDs.length; _i &lt; _len; _i++) {
              dID = deviceIDs[_i];
              this.demobo.callFunction(functionName, data, dID);
            }
            return false;
          }
        };

        /*</pre></div></div>
            
        </li>
        
        
        <li id="section-47">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-47">&#182;</a>
              </div>
              <p>If the event is already registered, add a handler to its dispatcher; otherwise create a new dispatcher</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        */


        DemoboPortal.prototype.addEventListener = function(eventName, handler, boboID) {
          var dispatcher, handlers, _temp;

          handlers = this.get('eventHandlers');
          dispatcher = handlers[eventName];
          console.log(dispatcher != null);
          if (dispatcher != null) {
            handlers[eventName].addHandler(boboID, handler);
          } else {
            dispatcher = new Dispatcher(eventName, this);
            handlers[eventName] = dispatcher;
            dispatcher.addHandler(boboID, handler);
            _temp = {};
            _temp[eventName] = function() {
              return dispatcher.dispatch.apply(dispatcher, arguments);
            };
            this.demobo.mapInputEvents(_temp);
          }
          return true;
        };

        /*</pre></div></div>
            
        </li>
        
        
        <li id="section-48">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-48">&#182;</a>
              </div>
              <p>Get the boboID of the device, based on the current mapping</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        */


        DemoboPortal.prototype.getDeviceBoboID = function(deviceID) {
          var map;

          map = this.get('deviceBoboMap');
          return map[deviceID];
        };

        /*</pre></div></div>
            
        </li>
        
        
        <li id="section-49">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-49">&#182;</a>
              </div>
              <p>Set a device&#39;s controller</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        */


        DemoboPortal.prototype.setDeviceController = function(boboObj, deviceID) {
          return this.demobo.setController(boboObj.getInfo('controller'), deviceID);
        };

        /*</pre></div></div>
            
        </li>
        
        
        <li id="section-50">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-50">&#182;</a>
              </div>
              <p>Return true if <code>deviceID</code> is already in the mapping; false otherwise.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        */


        DemoboPortal.prototype.hasDevice = function(deviceID) {
          return __indexOf.call(this.get('deviceBoboMap'), deviceID) &gt;= 0;
        };

        /*</pre></div></div>
            
        </li>
        
        
        <li id="section-51">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-51">&#182;</a>
              </div>
              <p>Add a device</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        */


        DemoboPortal.prototype.addDevice = function(deviceID, boboID) {
          if (!this.hasDevice(deviceID)) {
            if (!boboID) {
              /* if boboID is not specified, set it to the current boboID
              */

              boboID = this.get('curBobo').getInfo('boboID');
            }
            this.get('deviceBoboMap')[deviceID] = boboID;
            this.get('boboDeviceMap')[boboID].push(deviceID);
            this.trigger('add:device', deviceID);
            return true;
          }
          return false;
        };

        /*</pre></div></div>
            
        </li>
        
        
        <li id="section-52">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-52">&#182;</a>
              </div>
              <p>Delete <code>deviceID</code> from the mapping</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        */


        DemoboPortal.prototype.removeDevice = function(deviceID) {
          var boboID, devices;

          boboID = this.getDeviceBoboID(deviceID);
          devices = this.get('boboDeviceMap')[boboID];
          devices.splice(devices.indexOf(deviceID), 1);
          delete this.get('deviceBoboMap')[deviceID];
          this.trigger('delete:device', deviceID);
          return true;
        };

        /* Set the mappings so that `deviceID` points to `boboID`
        */


        DemoboPortal.prototype.setDevice = function(deviceID, boboID) {
          var devices, oldBoboId;

          if (this.hasDevice(deviceID)) {
            oldBoboId = this.getDeviceBoboID(deviceID);
            if (oldBoboId === boboID) {
              return false;
            } else {
              this.get('deviceBoboMap')[deviceID] = boboID;
              devices = this.get('boboDeviceMap')[oldBoboID];
              devices.splice(devices.indexOf(deviceID), 1);
              this.get('boboDeviceMap')[boboID].push(deviceID);
              this.trigger('change:device', deviceID, oldBoboID, boboID);
              return true;
            }
          } else {
            return this.addDevice(deviceID);
          }
        };

        /*</pre></div></div>
            
        </li>
        
        
        <li id="section-53">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-53">&#182;</a>
              </div>
              <p>TODO: might be remvoed?</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        */


        DemoboPortal.prototype.setController = function(controller) {
          return this.demobo.setController(controller);
        };

        /*</pre></div></div>
            
        </li>
        
        
        <li id="section-54">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-54">&#182;</a>
              </div>
              <p>Switch to another bobo</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        */


        DemoboPortal.prototype.switchBobo = function(boboID) {
          var boboDeviceMap, deviceBoboMap, deviceID, devices, newBobo, oldBoboID, _i, _len;

          oldBoboID = this.get('curBobo').getInfo('boboID');
          boboDeviceMap = this.get('boboDeviceMap');
          deviceBoboMap = this.get('deviceBoboMap');
          devices = boboDeviceMap[oldBoboID];
          for (_i = 0, _len = devices.length; _i &lt; _len; _i++) {
            deviceID = devices[_i];
            deviceBoboMap[deviceID] = boboID;
          }
          boboDeviceMap[boboID] = devices.slice();
          boboDeviceMap[oldBoboID] = [];
          newBobo = this.get('bobos')[boboID];
          this.setDeviceController(newBobo);
          this.set('curBobo', newBobo);
          newBobo.resume();
          return true;
        };

        /*</pre></div></div>
            
        </li>
        
        
        <li id="section-55">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-55">&#182;</a>
              </div>
              <p>Take an argument of a extended <code>Bobo</code> class and create a new <code>Bobo</code> instance.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        */


        DemoboPortal.prototype.addBobo = function(boboClass) {
          var boboID, boboObj, bobos, eventName, handler, handlers, temp;

          boboObj = new boboClass(this);
          /*</pre></div></div>
            
        </li>
        
        
        <li id="section-56">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-56">&#182;</a>
              </div>
              <p>If <code>boboID</code> dosn&#39;t exist, set <code>boboID</code> to this bobo&#39;s controller url</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          */

          temp = boboObj.getInfo('boboID');
          if (temp) {
            boboID = temp;
          } else {
            boboID = boboObj.getInfo('controller').url;
            boboObj.setInfo('boboID', boboID);
          }
          bobos = this.get('bobos');
          if (__indexOf.call(bobos, boboID) &lt; 0) {
            bobos[boboID] = boboObj;
            this.get('boboDeviceMap')[boboID] = [];
            handlers = boboObj.getInfo('inputEventHandlers');
            for (eventName in handlers) {
              handler = handlers[eventName];
              this.addEventListener(eventName, handler, boboID);
            }
            if (!this.get('curBobo')) {
              this.set('curBobo', boboObj);
              /* shame to have to code this like this...
              */

              setTimeout(function() {
                return window.demobo.getDeviceInfo.apply(window.demobo, ['', 'g=function f(data){window.demoboPortal.addExistentDevice.apply(window.demoboPortal, [data])}']);
              }, 1000);
            }
            this.trigger('add:bobos', boboID, boboObj);
            return true;
          }
          return false;
        };

        /*</pre></div></div>
            
        </li>
        
        
        <li id="section-57">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-57">&#182;</a>
              </div>
              <p>Return the value of the key</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        */


        DemoboPortal.prototype.get = function(key) {
          return this.attributes[key];
        };

        /*</pre></div></div>
            
        </li>
        
        
        <li id="section-58">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-58">&#182;</a>
              </div>
              <p>Register a event with its handler</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        */


        DemoboPortal.prototype.on = function(eventName, handler) {
          this._events[eventName] = handler;
          return true;
        };

        /*</pre></div></div>
            
        </li>
        
        
        <li id="section-59">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-59">&#182;</a>
              </div>
              <p>Trigger event</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        */


        DemoboPortal.prototype.trigger = function(eventName) {
          var handler;

          if ((handler = this._events[eventName])) {
            handler.apply(this, [].slice.apply(arguments, [1]));
            return true;
          } else {
            return false;
          }
        };

        /*</pre></div></div>
            
        </li>
        
        
        <li id="section-60">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-60">&#182;</a>
              </div>
              <p>Set an attribute&#39;s value. If the old value is different from the new value, &#39;change:<code>key</code>&#39; is triggered</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        */


        DemoboPortal.prototype.set = function(key, val) {
          var oldVal;

          oldVal = this.attributes[key];
          if (!(oldVal === val)) {
            this.attributes[key] = val;
            this.trigger('change:' + key, oldVal, val);
          }
          return oldVal;
        };

        /*</pre></div></div>
            
        </li>
        
        
        <li id="section-61">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-61">&#182;</a>
              </div>
              <p>Create the view of a bobo, which would be showed up in portal</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        */


        DemoboPortal.prototype.createBoboView = function(boboID, boboInfo) {
          var boboObj, d, i, menuContainer;

          menuContainer = document.getElementById('demoboMenuContainer');
          if (menuContainer) {
            d = document.createElement('div');
            d.className = 'demoboBoboItem';
            i = document.createElement('img');
            i.className = 'demoboBoboIcon';
            i.src = base + boboInfo.iconUrl;
            boboObj = this;
            i.onclick = function() {
              boboObj.switchBobo(boboID);
              return console.log('wanna switched to ' + boboID);
            };
            d.appendChild(i);
            menuContainer.appendChild(d);
            return d;
          }
          return null;
        };

        return DemoboPortal;

      })();
      /*</pre></div></div>
            
        </li>
        
        
        <li id="section-62">
            <div class="annotation">
              
              <div class="pilwrap for-h2">
                <a class="pilcrow" href="#section-62">&#182;</a>
              </div>
              <h2>Execution</h2>

            </div>
            
        </li>
        
        
        <li id="section-63">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-63">&#182;</a>
              </div>
              <p>instantiate a <code>DemoboPortal</code> object and expose to global use</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      */

      loadJS('//api.demobo.com/demobo.1.7.0.min.js', function() {
        var container, cssContent, demoboCss, demoboPortal, icon;

        demoboPortal = new DemoboPortal();
        window.demoboPortal = demoboPortal;
        /*</pre></div></div>
            
        </li>
        
        
        <li id="section-64">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-64">&#182;</a>
              </div>
              <p>Set up css for the small cute de Mobo icon.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        */

        demoboCss = document.createElement('style');
        demoboCss.className = 'demoboCSS';
        cssContent = "      #demoboMiniIcon {        z-index:10000;        width:30px;        opacity:0.15;        position:fixed;        right:20px;        bottom:60px;        -webkit-transition: opacity 0.5s ease;        transition: opacity 0.5x ease;        cursor:pointer;      }        #demoboMiniIcon:hover {        opacity:0.7;      }      #demoboMiniIcon.selected {        opacity:0.7;      }            #demoboMiniIcon:active {        opacity:1;      }      ";
        demoboCss.innerText = cssContent;
        document.body.appendChild(demoboCss);
        /*</pre></div></div>
            
        </li>
        
        
        <li id="section-65">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-65">&#182;</a>
              </div>
              <p>Small demobo icon at the right bottom of the page</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        */

        container = document.createElement('div');
        icon = document.createElement('img');
        icon.className = 'demoboIMG';
        icon.id = 'demoboMiniIcon';
        icon.title = 'demobo mini';
        icon.src = base + 'demobo.png';
        container.appendChild(icon);
        document.body.appendChild(container);
        /*</pre></div></div>
            
        </li>
        
        
        <li id="section-66">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-66">&#182;</a>
              </div>
              <p>Load script of connection dialog and show the dialog if necessary</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        */

        loadJS(connectScript);
        /*</pre></div></div>
            
        </li>
        
        
        <li id="section-67">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-67">&#182;</a>
              </div>
              <p>Setup click handler of our small cute de Mobo icon</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        */

        return icon.onclick = function() {
          if (icon.classList.length === 1) {
            return window._showDemoboConnect();
          } else {
            return window._hideDemoboConnect();
          }
        };
      });
    }
    delete window.demoboLoading;
  }

}).call(this);</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
