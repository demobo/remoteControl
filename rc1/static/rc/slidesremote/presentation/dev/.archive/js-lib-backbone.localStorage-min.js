(function(d,b){"object"==typeof exports&&"function"==typeof require?module.exports=b(require("underscore"),require("backbone")):"function"==typeof define&&define.amd?define(["underscore","backbone"],function(c,a){return b(c||d._,a||d.Backbone)}):b(_,Backbone)})(this,function(d,b){function c(){return(65536*(1+Math.random())|0).toString(16).substring(1)}return b.LocalStorage=window.Store=function(a){if(!this.localStorage)throw"Backbone.localStorage: Environment does not support localStorage.";this.name=
a;this.records=(a=this.localStorage().getItem(this.name))&&a.split(",")||[]},d.extend(b.LocalStorage.prototype,{save:function(){this.localStorage().setItem(this.name,this.records.join(","))},create:function(a){return a.id||(a.id=c()+c()+"-"+c()+"-"+c()+"-"+c()+"-"+c()+c()+c(),a.set(a.idAttribute,a.id)),this.localStorage().setItem(this.name+"-"+a.id,JSON.stringify(a)),this.records.push(a.id.toString()),this.save(),this.find(a)},update:function(a){return this.localStorage().setItem(this.name+"-"+a.id,
JSON.stringify(a)),d.include(this.records,a.id.toString())||this.records.push(a.id.toString()),this.save(),this.find(a)},find:function(a){return this.jsonData(this.localStorage().getItem(this.name+"-"+a.id))},findAll:function(){return(d.chain||d)(this.records).map(function(a){return this.jsonData(this.localStorage().getItem(this.name+"-"+a))},this).compact().value()},destroy:function(a){return a.isNew()?!1:(this.localStorage().removeItem(this.name+"-"+a.id),this.records=d.reject(this.records,function(b){return b===
a.id.toString()}),this.save(),a)},localStorage:function(){return localStorage},jsonData:function(a){return a&&JSON.parse(a)},_clear:function(){var a=this.localStorage(),b=RegExp("^"+this.name+"-");a.removeItem(this.name);(d.chain||d)(a).keys().filter(function(a){return b.test(a)}).each(function(b){a.removeItem(b)});this.records.length=0},_storageSize:function(){return this.localStorage().length}}),b.LocalStorage.sync=window.Store.sync=b.localSync=function(a,f,e){var d=f.localStorage||f.collection.localStorage,
c,g,h=b.$.Deferred&&b.$.Deferred();try{switch(a){case "read":c=void 0!=f.id?d.find(f):d.findAll();break;case "create":c=d.create(f);break;case "update":c=d.update(f);break;case "delete":c=d.destroy(f)}}catch(k){22===k.code&&0===d._storageSize()?g="Private browsing is unsupported":g=k.message}return c?(e&&e.success&&("0.9.10"===b.VERSION?e.success(f,c,e):e.success(c)),h&&h.resolve(c)):(g=g?g:"Record Not Found",e&&e.error&&("0.9.10"===b.VERSION?e.error(f,g,e):e.error(g)),h&&h.reject(g)),e&&e.complete&&
e.complete(c),h&&h.promise()},b.ajaxSync=b.sync,b.getSyncMethod=function(a){return a.localStorage||a.collection&&a.collection.localStorage?b.localSync:b.ajaxSync},b.sync=function(a,c,d){return b.getSyncMethod(c).apply(this,[a,c,d])},b.LocalStorage});
